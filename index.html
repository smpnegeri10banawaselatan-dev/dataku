<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Aset Sekolah â€” Rekap Kabupaten</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .card { background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .collapse-header { cursor:pointer; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">
<div class="container mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4 text-center">ðŸ“Š Dashboard Aset Sekolah â€” Rekap Kabupaten</h1>

  <div class="flex flex-col md:flex-row gap-4 mb-4 items-start">
    <div class="card w-full md:w-2/3">
      <label class="block font-semibold mb-2">Pilih Kecamatan</label>
      <select id="kecamatanSelect" class="p-2 border rounded w-full mb-2"></select>
    </div>
    <div class="card w-full md:w-1/3 flex flex-col gap-2">
      <button id="refreshBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">ðŸ”„ Muat Ulang Data</button>
      <button id="exportAllExcel" class="px-3 py-2 bg-green-600 text-white rounded">ðŸ“¥ Export Semua (Excel)</button>
      <button id="exportAllPDF" class="px-3 py-2 bg-red-600 text-white rounded">ðŸ“„ Export Semua (PDF)</button>
    </div>
  </div>

  <div id="loading" class="hidden mb-6">
    <div class="flex items-center gap-3">
      <div class="animate-spin w-6 h-6 border-2 border-blue-300 border-t-blue-600 rounded-full"></div>
      <div class="text-sm font-medium">Memuat data dari spreadsheet...</div>
    </div>
  </div>

  <div id="detailContainer" class="mb-10"></div>
</div>

<script>
const dataKecamatan = {
 "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCAaRZ9atAiEb-BvMChP_3Wq6wtmUUlNiTWVtwzh7r9KX5sRRZpq5WppSrSebym8z6-qI3zfWQOTNu/pub?gid=0&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vToEAn2MqanfOGSKsDsV0cfGeXt6mJhf7DPEzgFeBl8GQkrbzd4iFuM3tRwyo_wV6m9PlxjQ-9Z0QhC/pub?gid=0&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwth8ToDewTdvfvhlYuywOolNFwvc6eA4wer_OGKgNk-FoDvIQaHthsQHtMiis3cAsj4AnLzYKXG9p/pub?gid=0&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQX_Z6U7nanrMlPxL8N1m40jkFiMAHCIbZQA_iljNj3QZ8Z5FGMTAzYBbAC_D9Xy2PT3fUf0LL0n7F/pub?gid=0&single=true&output=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcReqyQvHT1K094wmITv7oL1dpVGSA7K139SmWIlNcJzVItMNLyCz0Q-u5Sg1H1QXs1R9mNyL73SBj/pub?gid=0&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGT-OgwESxefxs2tnW_OoIZk2c76I6fKSqaQUoibT4B_-QVNtPPMZSDnEaawJRGaLB3tP-ChoDugoi/pub?gid=0&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaDzmjVhNzRnMTJWg2JkvR1DYTiDSl2S6-MisvcSFD9P7MB2rVxA2zRgS0Rd0-f-xpIt1db1O1ppXx/pub?gid=0&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnq_cellwa56qRzTfYLpUxHoLxpiQOBBmiAUCkdeJK8-tLMVawW9BLrWUA_Q_kMswogfdZlmWjHGQT/pub?gid=0&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS11oEXPUetCOBorbbFNejuPEMsw4L8GYp-ETIbncBOgBfOtvLruTC82mUd-vxb7fj6sXopy16axzXi/pub?gid=0&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg_48k1uaVtdc2v4UgVwn3PBxAFP4gfEhIR_OCBKVOcSrHRUYS1jPO1P1E1qnHGM_WcqDB2TFkE74t/pub?gid=0&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpFtH1q7lOez0grPXzNd1AAU93FZQZPSCyVrT4RneIumbxU0CbvukEfotyjhq01gYVLhK0_WblO_HO/pub?gid=0&single=true&output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQevpAs3bjvgOzZDc8uq2PoebzqXVEFCvggoqJvn8AO-d1M0BCI0k7QYKB9hTgymfUIXx68oVR27IV/pub?gid=0&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQljJh_fOmCwjRVlTt5k8WxpN3TzaSyhWDXNnkDjI8hm62x1jdE41mXNENd2iGUueNyuXJuLa4jpoF6/pub?gid=0&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTIi8ZSNx9-MetxVLFAxiS4MeBiFOuOeYbe4_Bf9EEQ2btWYDfIY15B6r_tBg33l0AFATRQrdoQyMq/pub?gid=0&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_M8W7eNSRgJiDs-lU0zBDAT2OEAN6J1g1G9UvgreUf7GS0_Q987XsgzYdDESWAu_P86BezxKn6nJl/pub?gid=0&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJAkrtkVPBLcUmM8OsByQDfndFGv-6MetoMsB_DGoqimZQGcAg9Lxe_glv_qAJoVXoY9TCHdnCDa6Y/pub?gid=0&single=true&output=csv"
};

let allData = [];

/* Helpers */
function normalize(s){ return (s||"").toString().trim().toLowerCase(); }
function getNormalizedRow(row){ const map = {}; Object.keys(row||{}).forEach(k=>map[normalize(k)]=row[k]); return map; }
function pickField(nrow, candidates){ for(const c of candidates) if(nrow[c]!==undefined && nrow[c]!==null && nrow[c].toString().trim()!=="") return nrow[c]; return ""; }
function parseNilai(raw){ if(!raw) return 0; const n = Number(raw.toString().replace(/[^\d]/g,'')); return isNaN(n)?0:n; }
function adjustNilaiSkala(nilai){ return (nilai>10000000)?Math.round(nilai/100):nilai; }
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* Load data */
async function loadAllFromSpreadsheets(){
  allData = [];
  showLoading(true);
  const select = document.getElementById('kecamatanSelect');
  select.innerHTML = `<option value="">-- Pilih Kecamatan --</option>`;
  Object.keys(dataKecamatan).forEach(k => { const o=document.createElement('option'); o.value=k; o.textContent=k; select.appendChild(o); });

  for(const [kecamatan,url] of Object.entries(dataKecamatan)){
    try{
      const res = await fetch(url);
      if(!res.ok) continue;
      const csv = await res.text();
      const rows = Papa.parse(csv, { header:true, skipEmptyLines:true }).data || [];
      rows.forEach(rawRow=>{
        const n = getNormalizedRow(rawRow);
        const sekolah = pickField(n,['pengguna','sekolah','pengguna_barang'])||"Tidak Diketahui";
        const barang = pickField(n,['nama barang','nama_barang','barang'])||"-";
        const nibar = pickField(n,['nibar','no register','no_register_barang'])||"-";
        const kondisiSbl = pickField(n,['kondisi sebelumnya','kondisi_sebelumnya'])||"-";
        const kondisiNow = pickField(n,['kondisi saat ini','kondisi_saat_ini','kondisi'])||kondisiSbl||"-";
        const rawNilai = pickField(n,['nilai perolehan','harga','harga perolehan'])||0;
        let nilai = parseNilai(rawNilai);
        nilai = adjustNilaiSkala(nilai);
        const kecFromRow = pickField(n,['kecamatan','kec','wilayah'])||kecamatan;
        allData.push({ kecamatan:kecFromRow,sekolah,barang,nibar,kondisiSebelumnya:kondisiSbl,kondisiSaatIni:kondisiNow,nilai });
      });
    } catch(e){ console.error("Error", e); }
  }
  showLoading(false);
}

/* Loading UI */
function showLoading(on){ document.getElementById('loading').classList.toggle('hidden',!on); }

/* Show detail */
function showDetailForKecamatan(kecamatan){
  const rows = allData.filter(r=>(r.kecamatan||'').trim()===(kecamatan||'').trim());
  const bySchool = {};
  rows.forEach(r=>{ const s=r.sekolah||'Tidak Diketahui'; if(!bySchool[s]) bySchool[s]=[]; bySchool[s].push(r); });

  // Rekap kategori kecamatan
  const totalKategori = { 'Baik':0, 'Rusak Ringan':0, 'Rusak Berat':0, 'Ditemukan':0, 'Tidak Ditemukan':0 };
  rows.forEach(r=>{
    const k = (r.kondisiSaatIni||'').toLowerCase();
    if(k.includes('baik')) totalKategori['Baik']++;
    else if(k.includes('rusak ringan')) totalKategori['Rusak Ringan']++;
    else if(k.includes('rusak berat')) totalKategori['Rusak Berat']++;
    else if(k.includes('ditemukan')) totalKategori['Ditemukan']++;
    else totalKategori['Tidak Ditemukan']++;
  });

  const container = document.getElementById('detailContainer');
  container.innerHTML = `<h2 class="text-xl font-semibold mb-2">Detail Kecamatan â€” ${kecamatan}</h2>`;

  // Rekap kategori
  let rekapHTML = '<div class="mb-4 flex gap-4 text-sm font-semibold">';
  for(const [cat, val] of Object.entries(totalKategori)){
    rekapHTML += `<div class="bg-gray-200 px-3 py-1 rounded">${cat}: ${val}</div>`;
  }
  rekapHTML += '</div>';
  container.innerHTML += rekapHTML;

  // Sekolah
  Object.entries(bySchool).forEach(([school,items])=>{
    const totalNilai = items.reduce((s,it)=>s+(it.nilai||0),0);

    const card = document.createElement('div');
    card.className='card mb-4';

    // Kategori per sekolah
    const categories = { 'Baik':[], 'Rusak Ringan':[], 'Rusak Berat':[], 'Ditemukan':[], 'Tidak Ditemukan':[] };
    items.forEach(it=>{
      const k = (it.kondisiSaatIni||'').toLowerCase();
      if(k.includes('baik')) categories['Baik'].push(it);
      else if(k.includes('rusak ringan')) categories['Rusak Ringan'].push(it);
      else if(k.includes('rusak berat')) categories['Rusak Berat'].push(it);
      else if(k.includes('ditemukan')) categories['Ditemukan'].push(it);
      else categories['Tidak Ditemukan'].push(it);
    });

    let contentHTML = '';
    for(const [cat, list] of Object.entries(categories)){
      if(list.length===0) continue;
      contentHTML += `<div class="mb-2">
        <div class="font-semibold mb-1">${cat} (${list.length})</div>
        <table class="w-full text-sm border">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2">Nama Barang</th>
              <th class="p-2">NIBAR</th>
              <th class="p-2">Kondisi Sebelumnya</th>
              <th class="p-2">Kondisi Saat Ini</th>
              <th class="p-2">Nilai (Rp)</th>
            </tr>
          </thead>
          <tbody>
            ${list.map(it=>`<tr class="border-b">
              <td class="p-2">${escapeHtml(it.barang)}</td>
              <td class="p-2">${escapeHtml(it.nibar)}</td>
              <td class="p-2">${escapeHtml(it.kondisiSebelumnya)}</td>
              <td class="p-2">${escapeHtml(it.kondisiSaatIni)}</td>
              <td class="p-2 text-right">${(it.nilai||0).toLocaleString('id-ID')}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
    }

    card.innerHTML = `
      <div class="collapse-header font-semibold mb-2">${school} â€” Total Nilai: Rp ${totalNilai.toLocaleString('id-ID')}</div>
      <div class="collapse-content hidden">${contentHTML}
        <div class="mt-2 flex gap-2">
          <button class="px-3 py-1 bg-green-600 text-white rounded export-school-excel">Export Excel</button>
          <button class="px-3 py-1 bg-red-600 text-white rounded export-school-pdf">Export PDF</button>
        </div>
      </div>
    `;
    container.appendChild(card);

    card.querySelector('.collapse-header').addEventListener('click', ()=>{
      const content = card.querySelector('.collapse-content');
      content.classList.toggle('hidden');
    });

    card.querySelector('.export-school-excel').addEventListener('click', ()=> exportSchoolExcel(school, items));
    card.querySelector('.export-school-pdf').addEventListener('click', async ()=> exportElementToPDF(card, `${school}_Detail.pdf`));
  });
}

/* Export helpers */
function exportSchoolExcel(schoolName, list){
  const rows = list.map(it=>({
    'Nama Sekolah': schoolName,
    'Nama Barang': it.barang,
    'NIBAR': it.nibar,
    'Kondisi Sebelumnya': it.kondisiSebelumnya,
    'Kondisi Saat Ini': it.kondisiSaatIni,
    'Nilai Perolehan (Rp)': it.nilai
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Detail');
  XLSX.writeFile(wb, `${schoolName}_Detail.xlsx`);
}
async function exportElementToPDF(el, filename){
  const canvas = await html2canvas(el,{scale:2,useCORS:true});
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = canvas.height*pdfWidth/canvas.width;
  pdf.addImage(img,'PNG',0,0,pdfWidth,pdfHeight);
  pdf.save(filename);
}

/* Event listeners */
document.getElementById('refreshBtn').addEventListener('click', loadAllFromSpreadsheets);
document.getElementById('kecamatanSelect').addEventListener('change', e=>{
  const v=e.target.value; if(!v) document.getElementById('detailContainer').innerHTML=''; else showDetailForKecamatan(v);
});
document.getElementById('exportAllExcel').addEventListener('click', ()=>{
  const ws = XLSX.utils.json_to_sheet(allData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'AllData');
  XLSX.writeFile(wb,'Rekap_Aset_All_Kecamatan.xlsx');
});
document.getElementById('exportAllPDF').addEventListener('click', async ()=>{
  const el = document.querySelector('.container') || document.body;
  await exportElementToPDF(el,'Rekap_Aset_All_Kecamatan.pdf');
});

/* Init */
loadAllFromSpreadsheets();
</script>
</body>
</html>
